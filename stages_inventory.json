[
  {
    "stageKey": "greeting",
    "file": "lib/ddsa/stages/greeting-stage.ts",
    "summary": "Initial personalized greeting with challenge detection, transitions to CFQ after 2-3 rounds",
    "acceptsTenantId": "YES",
    "callsSaveDdsState": "YES",
    "saveDdsStateLines": [
      "74-107: await input.saveDdsState(threadId, updatedState)",
      "155-186: await input.saveDdsState(threadId, updatedState)",
      "212-225: await input.saveDdsState(threadId, updatedState)",
      "261-270: await input.saveDdsState(threadId, updatedState)",
      "573-583: await input.saveDdsState(threadId, updatedState)",
      "650-680: await input.saveDdsState(threadId, updatedState)"
    ],
    "passesTenantIdToSave": "NO",
    "saveDdsStateSnippet": "await input.saveDdsState(threadId, updatedState)",
    "usesAIClient": "tenant-aware",
    "aiClientImport": "import { generateNaturalGreeting } from '../greeting-handler'",
    "usesTemplates": "YES",
    "templateUsage": "Uses greeting-handler which uses templates from lib/ddsa/greeting/template.ts",
    "auditLogPassesTenantId": "YES",
    "auditLogSnippet": "await audit.log('GREETING.STAGE.CHALLENGE_DETECTION', {...}, input.tenantId)",
    "helpsWith": ["intent"],
    "notes": "Transitions to CFQ via nextStage: 'cfq' in return value. Does not check confirmedIntent before asking questions."
  },
  {
    "stageKey": "cfq",
    "file": "lib/ddsa/stages/cfq-stage.ts",
    "summary": "Connection-First Question stage, asks intelligent questions without greeting",
    "acceptsTenantId": "YES",
    "callsSaveDdsState": "UNKNOWN",
    "passesTenantIdToSave": "UNKNOWN",
    "usesAIClient": "tenant-aware",
    "aiClientImport": "Uses QOL (questioning_orchestrator) which uses createTenantResponsesClient",
    "usesTemplates": "NO",
    "auditLogPassesTenantId": "YES",
    "auditLogSnippet": "await audit.log('CFQ.QUESTION_SENT', {...}, input.tenantId)",
    "helpsWith": ["intent"],
    "notes": "Does not check confirmedIntent. May ask redundant questions after intent is confirmed."
  },
  {
    "stageKey": "intent",
    "file": "lib/ddsa/stages/intent-stage.ts",
    "summary": "Intent classification with confirm-intent flow (A/B/C), integrates QOL for confirm prompts",
    "acceptsTenantId": "YES",
    "callsSaveDdsState": "YES",
    "saveDdsStateLines": [
      "260-261: await input.saveDdsState(threadId, confirmResult.updatedState)"
    ],
    "passesTenantIdToSave": "NO",
    "saveDdsStateSnippet": "await input.saveDdsState(threadId, confirmResult.updatedState)",
    "usesAIClient": "tenant-aware",
    "aiClientImport": "import { generateWithQOL } from '../questioning_orchestrator' (uses createTenantResponsesClient)",
    "usesTemplates": "YES",
    "templateUsage": "Uses generateConfirmPrompt from lib/ddsa/templates/confirm-templates.ts",
    "auditLogPassesTenantId": "NO",
    "auditLogSnippet": "await audit.log('INTENT.QUESTION_SENT', {...}) - MISSING tenantId",
    "helpsWith": ["intent"],
    "notes": "Integrates confirm-intent flow via QOL. Handles A/B/C replies. Missing tenantId in some audit.log calls."
  },
  {
    "stageKey": "rapid_triage",
    "file": "MISSING: lib/ddsa/stages/rapid-triage.ts (helper exists at lib/ddsa/rapid-triage.ts)",
    "summary": "Rapid diagnostic questions (max 3) - helper function exists but no stage implementation file found",
    "acceptsTenantId": "YES",
    "callsSaveDdsState": "NO",
    "passesTenantIdToSave": "N/A",
    "usesAIClient": "tenant-aware",
    "aiClientImport": "import { respondWithTenantConfig } from '@/lib/ai/tenant-client'",
    "usesTemplates": "NO",
    "auditLogPassesTenantId": "UNKNOWN",
    "helpsWith": ["intent"],
    "notes": "BLOCKER: Stage referenced in manifest but no stage implementation file. Helper function exists at lib/ddsa/rapid-triage.ts (not in stages/). Need to create stage wrapper or remove from manifest."
  },
  {
    "stageKey": "expert_selection",
    "file": "MISSING: lib/ddsa/stages/expert-routing.ts (helper exists at lib/ddsa/expert-routing.ts)",
    "summary": "Expert routing and handoff - helper function exists but no stage implementation file found",
    "acceptsTenantId": "YES",
    "callsSaveDdsState": "NO",
    "passesTenantIdToSave": "N/A",
    "usesAIClient": "NO",
    "usesTemplates": "NO",
    "auditLogPassesTenantId": "UNKNOWN",
    "helpsWith": [],
    "notes": "BLOCKER: Stage referenced in manifest but no stage implementation file. Helper function exists at lib/ddsa/expert-routing.ts (not in stages/). Need to create stage wrapper or remove from manifest."
  },
  {
    "stageKey": "bundled_intake",
    "file": "lib/ddsa/stages/bundled-intake.ts",
    "summary": "Collect structured context: Where, Who, When, How, Resources",
    "acceptsTenantId": "YES",
    "callsSaveDdsState": "NO",
    "passesTenantIdToSave": "N/A",
    "usesAIClient": "NO",
    "usesTemplates": "NO",
    "auditLogPassesTenantId": "NO",
    "auditLogSnippet": "await audit.log('BUNDLED_INTAKE.COMPLETED', {...}) - MISSING tenantId",
    "helpsWith": ["stakeholders"],
    "notes": "Does not check confirmedIntent before asking generic questions. Missing tenantId in audit.log."
  },
  {
    "stageKey": "stakeholders",
    "file": "lib/ddsa/stages/stakeholders-stage.ts",
    "summary": "Discover and classify stakeholders using SDEP engine or Responses API",
    "acceptsTenantId": "YES",
    "callsSaveDdsState": "NO",
    "passesTenantIdToSave": "N/A",
    "usesAIClient": "tenant-aware",
    "aiClientImport": "import { generateQuestionWithResponses } from '../responses-helper' (uses createResponse with tenantId)",
    "usesTemplates": "NO",
    "auditLogPassesTenantId": "NO",
    "auditLogSnippet": "await audit.log('STAKEHOLDERS.DISCOVERED', {...}) - MISSING tenantId",
    "helpsWith": ["stakeholders"],
    "notes": "Does not check confirmedIntent. May ask redundant questions. Missing tenantId in audit.log."
  },
  {
    "stageKey": "history",
    "file": "lib/ddsa/stages/history-stage.ts",
    "summary": "Collect prior attempts, timelines, successes, or failures",
    "acceptsTenantId": "YES",
    "callsSaveDdsState": "NO",
    "passesTenantIdToSave": "N/A",
    "usesAIClient": "NO",
    "usesTemplates": "NO",
    "auditLogPassesTenantId": "UNKNOWN",
    "helpsWith": [],
    "notes": "Does not check confirmedIntent. May ask redundant questions."
  },
  {
    "stageKey": "assumptions",
    "file": "lib/ddsa/stages/assumptions-stage.ts",
    "summary": "List 2-5 inferred assumptions for confirmation",
    "acceptsTenantId": "YES",
    "callsSaveDdsState": "NO",
    "passesTenantIdToSave": "N/A",
    "usesAIClient": "NO",
    "usesTemplates": "NO",
    "auditLogPassesTenantId": "UNKNOWN",
    "helpsWith": [],
    "notes": "Does not check confirmedIntent."
  },
  {
    "stageKey": "core_problem",
    "file": "lib/ddsa/stages/core-problem.ts",
    "summary": "Summarize verified root cause; wait for confirmation",
    "acceptsTenantId": "YES",
    "callsSaveDdsState": "NO",
    "passesTenantIdToSave": "N/A",
    "usesAIClient": "NO",
    "usesTemplates": "NO",
    "auditLogPassesTenantId": "NO",
    "auditLogSnippet": "await audit.log('CORE_PROBLEM.CONFIRMED', {...}) - MISSING tenantId",
    "helpsWith": ["options", "plan"],
    "notes": "Does not check confirmedIntent. Missing tenantId in audit.log."
  },
  {
    "stageKey": "options",
    "file": "lib/ddsa/stages/options.ts",
    "summary": "Offer 2-4 neutral solution paths with Pros/Cons/Timeline/Resource Need",
    "acceptsTenantId": "YES",
    "callsSaveDdsState": "NO",
    "passesTenantIdToSave": "N/A",
    "usesAIClient": "NO",
    "usesTemplates": "NO",
    "auditLogPassesTenantId": "YES",
    "auditLogSnippet": "await audit.log('OPTIONS.PRESENTED', {...}, input.tenantId)",
    "helpsWith": ["options"],
    "notes": "Generates options but does not check confirmedIntent. Options are generic (Quick Wins, Comprehensive, Hybrid, Pilot)."
  },
  {
    "stageKey": "plan",
    "file": "lib/ddsa/stages/plan-stage.ts",
    "summary": "Generates enriched plan with ACTION_PACKET candidates",
    "acceptsTenantId": "YES",
    "callsSaveDdsState": "NO",
    "passesTenantIdToSave": "N/A",
    "usesAIClient": "NO",
    "usesTemplates": "NO",
    "auditLogPassesTenantId": "YES",
    "auditLogSnippet": "await audit.log('PLAN.GENERATED', {...}, input.tenantId)",
    "helpsWith": ["plan"],
    "notes": "Uses generateEnrichedPlan helper. Does not check confirmedIntent or scopeLock."
  },
  {
    "stageKey": "enrichment",
    "file": "lib/ddsa/stages/enrichment-stage.ts",
    "summary": "Runs consent-gated enrichment modules",
    "acceptsTenantId": "YES",
    "callsSaveDdsState": "NO",
    "passesTenantIdToSave": "N/A",
    "usesAIClient": "NO",
    "usesTemplates": "NO",
    "auditLogPassesTenantId": "UNKNOWN",
    "helpsWith": [],
    "notes": "Background enrichment stage."
  },
  {
    "stageKey": "feedback_final",
    "file": "lib/ddsa/stages/feedback-final.ts",
    "summary": "Final feedback and refinement",
    "acceptsTenantId": "YES",
    "callsSaveDdsState": "NO",
    "passesTenantIdToSave": "N/A",
    "usesAIClient": "NO",
    "usesTemplates": "NO",
    "auditLogPassesTenantId": "YES",
    "auditLogSnippet": "await audit.log('FEEDBACK.COLLECTED', {...}, input.tenantId)",
    "helpsWith": [],
    "notes": "Final stage in pipeline."
  }
]
