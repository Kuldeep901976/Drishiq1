name: ðŸš€ DrishiQ Deployment Pipeline

on:
  push:
    branches: [dev, preprod]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'preprod'
        type: choice
        options:
        - dev
        - preprod
        - prod

env:
  NODE_VERSION: '18'
  SUPABASE_VERSION: '1.0.0'

jobs:
  # Development Deployment (Automatic)
  deploy-dev:
    if: github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    environment: development
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Run linting
        run: npm run lint

      - name: ðŸ§ª Run tests
        run: npm run test

      - name: ðŸ—„ï¸ Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: ${{ env.SUPABASE_VERSION }}

      - name: ðŸš€ Deploy to Development
        run: node drishiq-cli.js deploy dev
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_NAME: DrishiQ_Development

      - name: âœ… Development deployment complete
        run: echo "Development deployment successful!"

  # Pre-Production Deployment (Semi-automatic)
  deploy-preprod:
    if: github.ref == 'refs/heads/preprod' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'preprod')
    runs-on: ubuntu-latest
    environment: preprod
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Run linting
        run: npm run lint

      - name: ðŸ§ª Run comprehensive tests
        run: npm run test:preprod

      - name: ðŸ—„ï¸ Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: ${{ env.SUPABASE_VERSION }}

      - name: ðŸ” Schema validation
        run: node drishiq-cli.js test schema

      - name: ðŸš€ Deploy to Pre-Production
        run: node drishiq-cli.js deploy preprod
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_NAME: DrishiQ_PreProduction
          PREPROD_SUPABASE_URL: ${{ secrets.PREPROD_SUPABASE_URL }}
          PREPROD_SUPABASE_ANON_KEY: ${{ secrets.PREPROD_SUPABASE_ANON_KEY }}
          PREPROD_SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.PREPROD_SUPABASE_SERVICE_ROLE_KEY }}

      - name: ðŸ”„ Sync data from production
        run: node drishiq-cli.js sync-data prod preprod
        env:
          PROD_SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
          PROD_SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.PROD_SUPABASE_SERVICE_ROLE_KEY }}

      - name: âœ… Pre-production deployment complete
        run: echo "Pre-production deployment successful!"

  # Production Deployment (Manual approval required)
  deploy-prod:
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod')
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Run linting
        run: npm run lint

      - name: ðŸ§ª Run production tests
        run: npm run test:prod

      - name: ðŸ—„ï¸ Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: ${{ env.SUPABASE_VERSION }}

      - name: ðŸ” Schema validation
        run: node drishiq-cli.js test schema

      - name: ðŸ“ Generate production types
        run: node drishiq-cli.js generate-types prod

      - name: ðŸš€ Deploy to Production
        run: node drishiq-cli.js deploy prod
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_NAME: DrishiQ_Production
          PROD_SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
          PROD_SUPABASE_ANON_KEY: ${{ secrets.PROD_SUPABASE_ANON_KEY }}
          PROD_SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.PROD_SUPABASE_SERVICE_ROLE_KEY }}

      - name: ðŸ“Š Post-deployment health check
        run: |
          echo "Running health checks..."
          curl -f ${{ secrets.PROD_APP_URL }}/api/health || exit 1

      - name: âœ… Production deployment complete
        run: echo "Production deployment successful!"

  # Schema Migration Validation
  validate-schema:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ—„ï¸ Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: ${{ env.SUPABASE_VERSION }}

      - name: ðŸ” Validate schema changes
        run: |
          echo "Validating schema changes..."
          supabase db lint
          supabase db diff --schema public

      - name: ðŸ“ Generate migration report
        run: |
          echo "## Schema Migration Report" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Schema validation passed" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Changes detected:" >> $GITHUB_STEP_SUMMARY
          supabase db diff --schema public >> $GITHUB_STEP_SUMMARY

  # Security and Compliance Checks
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”’ Run security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: ðŸ“‹ Dependency audit
        run: npm audit --audit-level=moderate

  # Performance Testing (Pre-production only)
  performance-test:
    if: github.ref == 'refs/heads/preprod'
    runs-on: ubuntu-latest
    needs: deploy-preprod
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸƒâ€â™‚ï¸ Run performance tests
        run: npm run test:performance
        env:
          TEST_URL: ${{ secrets.PREPROD_APP_URL }}

      - name: ðŸ“Š Performance report
        run: |
          echo "## Performance Test Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Performance tests completed" >> $GITHUB_STEP_SUMMARY
