name: ðŸš€ Deploy to Render

on:
  push:
    branches: [master, main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: false
        default: 'preprod'
        type: choice
        options:
          - preprod
          - production

env:
  NODE_VERSION: '18'

jobs:
  # Build and validate before deployment
  build-validate:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Run linting
        run: npm run lint || echo "Linting warnings (non-blocking)"

      - name: ðŸ§ª Run type check
        run: npm run type-check || echo "Type check warnings (non-blocking)"

      - name: ðŸ”¨ Build application
        run: npm run build
        env:
          # These are dummy values for build - real values set in Render
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'https://placeholder.supabase.co' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'placeholder' }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY || 'placeholder' }}

      - name: âœ… Build successful
        run: echo "âœ… Build completed successfully! Render will auto-deploy."

  # Notify deployment status
  notify-deployment:
    needs: build-validate
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“ Deployment notification
        run: |
          echo "ðŸš€ Deployment triggered from ${{ github.ref_name }} branch!"
          echo "ðŸ“¦ Commit: ${{ github.sha }}"
          echo "ðŸ‘¤ Author: ${{ github.actor }}"
          echo "ðŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ðŸ”— Repository: ${{ github.repository }}"
          echo ""
          echo "âœ… Build validation passed!"
          echo "ðŸ”„ Render will automatically deploy this commit from ${{ github.ref_name }} branch"
          echo "ðŸŒ Live URL: https://drishiq-preprod.onrender.com"

      - name: ðŸ“Š Create deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary - ${{ github.ref_name }} Branch" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Build Status:** Success" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ‘¤ **Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ¿ **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”„ **Render Status:** Auto-deploying from ${{ github.ref_name }} branch..." >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Live URL:** https://drishiq-preprod.onrender.com" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> â±ï¸ Deployment typically takes 5-10 minutes" >> $GITHUB_STEP_SUMMARY









