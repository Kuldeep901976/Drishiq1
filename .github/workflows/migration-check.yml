name: Migration Verification

on:
  pull_request:
    paths:
      - 'lib/ddsa/**'
      - 'lib/jobs/**'
      - 'lib/responses/**'
      - 'lib/ai/**'
      - 'migrations/**'
      - 'scripts/**'

jobs:
  verify:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type-check
        run: npx tsc --noEmit

      - name: Run tests
        run: npm test --silent
        continue-on-error: true

      - name: Run linter
        run: npm run lint || true

      - name: Check for deprecated API usage
        run: |
          if grep -r "beta\.threads" lib/ app/ --include="*.ts" --include="*.tsx" | grep -v "message-exchange-layer.ts" | grep -v "archive/"; then
            echo "❌ Found beta.threads usage (excluding deprecated files)"
            exit 1
          fi
          echo "✅ No beta.threads usage found"

      - name: Check for MessageExchangeLayer imports
        run: |
          if grep -r "from.*message-exchange-layer" lib/ app/ --include="*.ts" --include="*.tsx" | grep -v "message-exchange-layer.ts" | grep -v "archive/"; then
            echo "❌ Found MessageExchangeLayer imports (excluding deprecated files)"
            exit 1
          fi
          echo "✅ No MessageExchangeLayer imports found"

      - name: Verify migration files exist
        run: |
          test -f migrations/20250115_013_responses_api_migration.sql || (echo "❌ Missing migration 013" && exit 1)
          test -f migrations/20250115_014_create_ai_responses.sql || (echo "❌ Missing migration 014" && exit 1)
          test -f migrations/20250115_015_create_ai_jobs.sql || (echo "❌ Missing migration 015" && exit 1)
          test -f lib/jobs/aiJobs.ts || (echo "❌ Missing aiJobs.ts" && exit 1)
          test -f scripts/run-ai-jobs-worker.ts || (echo "❌ Missing worker script" && exit 1)
          echo "✅ All required migration files present"

      - name: Run post-migration verification (dry run)
        if: runner.os == 'Windows'
        run: pwsh -c "./scripts/post-migration-verification.ps1 -DryRun"
        continue-on-error: true

      - name: Summary
        run: |
          echo "✅ Migration verification complete"
          echo "All checks passed (or non-blocking)"

