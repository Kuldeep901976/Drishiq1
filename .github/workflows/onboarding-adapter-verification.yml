name: Onboarding Adapter Verification

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'lib/ddsa/adapters/**'
      - 'lib/ddsa/onboarding-stage-registry.ts'
      - 'lib/ddsa/onboarding-pipeline-executor.ts'
      - 'database/migrations/**'
      - 'tests/**/onboarding*.test.ts'
  push:
    branches: [feature/onboarding-adapter]

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run unit tests
        run: npm test -- main-stage-adapter --coverage
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage/lcov.info

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: ${{ secrets.STAGING_DB_URL }}
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run integration tests
        run: npm test -- onboarding-pipeline-executor
        continue-on-error: true  # Allow failure if DB not available
      
      - name: Check migration
        run: node scripts/db-migrate-check.js ${{ secrets.STAGING_DB_URL }}
        continue-on-error: true

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    env:
      STAGING_DB_URL: ${{ secrets.STAGING_DB_URL }}
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
      TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
      FEATURE_ONBOARDING_PIPELINE: 'true'
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run E2E tests
        run: npm test -- onboarding-flow-e2e
        continue-on-error: true  # Allow failure if staging DB not available
      
      - name: Verify database isolation
        run: |
          # Add script to verify chat_threads unchanged
          echo "Verifying database isolation..."
        continue-on-error: true

  lint-and-type-check:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter
        run: npm run lint -- --quiet
      
      - name: Type check
        run: npx tsc --noEmit --skipLibCheck

  migration-check:
    name: Migration Check
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: ${{ secrets.STAGING_DB_URL }}
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Check migration status
        run: node scripts/db-migrate-check.js
        continue-on-error: true

  summary:
    name: Verification Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, lint-and-type-check]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## Verification Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Integration Tests: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Lint & Type Check: ${{ needs.lint-and-type-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Migration Check: ${{ needs.migration-check.result }}" >> $GITHUB_STEP_SUMMARY



